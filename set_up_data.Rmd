---
title: "R Notebook"
output: html_notebook
---


```{r}
library(spotifyr)
library(tidyverse)
library(lubridate)
library(corrplot)
library(usethis)
library(ggthemes)

dir.create("data", showWarnings = FALSE)
```

```{r}
id <- "edcc2c4666f64421bf98439ad7daa85f"
secret <- "40de60ef43ca4831a5344c588a008fb4"

#id <- "518f769c96f344f5b34f907ba779b0b5"
#secret <- "8b12f741eea043c591f77d570348b842"
Sys.setenv(SPOTIFY_CLIENT_ID = id)
Sys.setenv(SPOTIFY_CLIENT_SECRET = secret)
access_token <- get_spotify_access_token()
```



```{r}
playlists <- c(
  "1978" = "3mt2ysylQQ2cccDPyGfKID",
  "1979" = "6bHjBCFN8Lqj0K54RWFci8", 
  "1980" = "7DCh6mOvaEGMVph25k7hyN", 
  "1981" = "5wbHH4DqF4AVuGmjXI8kcW",
  "1982" = "1bk6tO6d5oes6n0vhACi5x",
  "1983" = "7GN1ulgzXBWpn5VADARkNd",
  "1984" = "10QxRag5DoKSR0iOwZ48Lt",
  "1985" = "7fGtXiE8qbQzqEisHw5CLS",
  "1986" = "4rhgAIno9OiopUzNhOZDbc",
  "1987" = "3fniVM8pbMq8jcR23aVIY8",
  "1988" = "1LCUqaG3ZbFnpJweV1lrj1",
  "1989" = "5ZjZbTHc6JBVu921hwc6v2",
  "1991" = "61FusglQju0yXpz3v7nYd5",
  "1992" = "0p6VwHqAZNV9xw5HuIKHJd",
  "1993" = "35wZqszdyXNFCAztyLWlgT",
  "1995" = "5zYgmmRp9ozLstVry1JLbw",
  "1996" = "0YKbjLgCPsp7K3k2JH4NZw", 
  "1997" = "6NewzRggzRDBBPowRuXBor", 
  "1998" = "62FCnGM83VWvtv6zAlMgTd", 
  "1999" = "0pnzsH8zKvnymNKOfPrT1P",
  "2000s" = "4cMLyIDCh4X90wgyEwYneN",
  "2010" = "5naqjby3xICvJte3QMvHcs"
  )

```

```{r}
songs <- lapply(playlists, get_playlist_tracks)

songs_df <- dplyr::bind_rows(songs, .id = "year") %>%
  readr::write_tsv(file.path("data","songs_over_decades.tsv"))
```

```{r}
# WE need to send these in batches so we don't reach the request limits
split(songs_df$track.id)


track_lists <- paste0(paste0("'", songs_df$track.id, "'"), collapse = ",")
track_audio_info <- get_track_audio_features(tracks)
```

```{r}

track_audio_info <- track_audio_info[-which(unlist(lapply(track_audio_info, is.na)) != 18)]

track_audio_info %>% 
  dplyr::select()
  dplyr::bind_rows(songs) %>% 
  readr::write_tsv(file.path("data","audio_info.tsv"))
```

```{r}
# Write code here that would use dplyr::inner_join() to join together track_audio_info and songs_df by matching their songs for the 'by' argument
combined_df <- dplyr::inner_join(track_audio_info,songs_df_clean, by = "track.id")
```

Let's extract the actual song release year from the variable `track.album.release_date`
The dates look like this "1978-04-04"

```{r}
combined_df <- combined_df |> 
 dplyr::mutate(release_date = stringr::word(track.album.release_date, sep = "-", 1)) |> 
 dplyr::filter(!is.na(release_date))
```


```{r}
# Write code here that removes columns are unnecessary or just look like a bunch of jargon/garbage dplyr::select()
songs_df_clean <- songs_df |>
  select(year,added_at,track.id,track.name,track.popularity,track.album.name,track.album.release_date,track.album.total_tracks, release_date)

track_audio_info <- track_audio_info |>
  bind_rows() |>
  mutate(track.id = id)
```

```{r}
# Write code here that 

```


### Candace and Jabir pair code

```{r}
combined_df |> 
ggplot2::ggplot(ggplot2::aes(release_date, track.popularity)) + 
  ggplot2::geom_point() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r}
pop_var_df <- combined_df |> 
  dplyr::select(track.popularity, danceability, energy, key, loudness, mode, speechiness, acousticness, instrumentalness, liveness, valence, tempo, duration_ms, time_signature)

corr_df <- cor(pop_var_df)
corrplot(corr_df, order = 'hclust', addrect = 2)
```

## Has audio qualities changed over time for these popular tracks? 

For example, are tracks from 1970s louder than tracks from 1980s? 

Make plots, use correlations maybe. 

```{r}
# grabbing every variable for further use
top_five_all <- combined_df |>
  arrange(desc(track.popularity)) |>
  arrange(year) |>
  mutate(year = as.factor(year)) |>
  group_by(year) |>
  top_n(5,track.popularity)

combined_df |>
  ggplot(aes(x = year, y= tempo)) +
  geom_point()

top_five_all |>
  ggplot(aes(x = year, y = tempo)) +
  geom_point()

# the energy of the songs does go up half way through the 90s and 2000s but they do drop back down in the 2010s
top_five_all |>
  ggplot(aes(x = release_date, y = energy)) +
  geom_point() +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# the loudness seems to start to increase through out the 90s on into the 2000s 
top_five_all |>
  ggplot(aes(x = release_date, y = loudness)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

combined_df |>
  ggplot(aes(x = release_date, y = loudness)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# this also seems to increase even though any song can be danced to, also take note that there are less songs as the years increase
top_five_all |>
  ggplot(aes(x = release_date, y = danceability)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

combined_df |>
  ggplot(aes(x = release_date, y = danceability)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```


```{r}
# Start making some plots with ggplot2 and explore possible relationships between the year of the song and any other variable that we might have in the dataset that you think may be related in some way. 
# Also maybe look at popularity and audio information 

ggplot2::ggplot(songs_df, ggplot2::aes(track.album.release_date, track.popularity)) + 
  ggplot2::geom_point()

combined_df |>
  ggplot(aes(x = track.popularity, y = year)) +
  geom_point()

top_songs_df <- combined_df |>
  select(track.name,track.popularity,year) |>
  arrange(desc(track.popularity)) |>
  arrange(year) |>
  mutate(year = as.factor(year)) |>
  group_by(year) |>
  top_n(5,track.popularity)

 top_songs_df_of_one <- combined_df |>
  select(track.name,track.popularity,year) |>
  arrange(desc(track.popularity)) |>
  arrange(year) |>
  mutate(year = as.factor(year)) |>
  group_by(year) |>
  top_n(1,track.popularity)
```


```{r}
top_songs_df |>
  ggplot(aes(x = year, y = track.popularity)) +
  geom_point() +
  labs(
    title = "Top 3-5 songs each year",
    y = "popularity"
  )

top_songs_df |>
  ggplot(aes(x = track.name, y = track.popularity,color = year)) +
  geom_point() +
  facet_wrap(vars(year))

combined_df |>
  ggplot(aes(x = year, y = track.popularity)) +
  geom_point() +
  labs(title = "Every song in each year",
       subtitle = "An overall scale of each year",
       x = "year",
       y = "popularity") +
   theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ggthemes::theme_solarized()

top_songs_df |>
  ggplot(aes(x = track.name, y = track.popularity, fill = year)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

top_songs_df_of_one |>
  ggplot(aes(x = year, y = track.popularity)) +
  geom_point(color = "orange") +
  theme(axis.text.x = element_text(angle = 40,hjust = 1)) +
  labs(title = "Number one most popular song in each year",
       subtitle = "From 1978-2010",
       x = "Year",
       y = "popularity") +
 theme(panel.background = element_rect(fill = "black"),
        panel.grid.major = element_line(color = "black"),
        panel.grid.minor = element_line(color = "black"))
```

very unpopular songs having low ratings in popularity this playlist is filled with ear stredding ear bleeding horrible covers of songs

```{r}
worst_song_playlist <- "47LqfQL7pHzfCFl8wOjPn7"

trash_songs <- get_playlist_tracks(worst_song_playlist)

trash_songs |>
  ggplot(aes(x = track.name, y = track.popularity)) +
  geom_point()

trash_songs |>
  ggplot(aes(x = track.name, y = track.popularity)) +
  geom_bar(stat = "identity")

trash_songs |>
  ggplot(aes(x = track.name, y = track.popularity)) +
  geom_boxplot()
```

running t test between the popular songs and the unpopular songs

```{r}
t.test(trash_songs$track.popularity,top_songs_df$track.popularity)
```


```{r}
topsongsvstrash <- bind_rows(list(unpopular=trash_songs, popular=top_songs_df), .id= "song_group")

topsongsvstrash |>
  ggplot(aes(x = song_group, y = track.popularity)) +
  geom_violin()

ggplot(data = topsongsvstrash, aes(x = song_group, y = danceability)) +
  geom_violin()


```

getting audio data from trash playlist

```{r}

trash_audio_info <- trash_songs %>% 
  dplyr::select(track.id) %>% 
  purrr::pmap(function(track.id) {
    get_track_audio_features(track.id)
  }) %>% 
  dplyr::bind_rows() %>% 
  readr::write_tsv(file.path("data","trash_audio_info.tsv"))

trash_songs_df <- dplyr::inner_join(trash_songs, trash_audio_info, by = c("track.id" = "id" ))

combined_songs_df <- bind_rows(list(unpopular=trash_songs_df, popular=combined_df), .id= "song_group")

combined_songs_df |>
readr::write_tsv(file.path("data","combined_trash_and_popular.tsv"))

combined_songs_df |>
  ggplot(aes(x = song_group, y = danceability)) +
  geom_violin()

combined_songs_df |>
  ggplot(aes(x = song_group, y = tempo)) +
  geom_violin()

combined_songs_df |>
  ggplot(aes(x = song_group, y = liveness)) +
  geom_violin()

combined_songs_df |>
  ggplot(aes(x = song_group, y = instrumentalness)) +
  geom_violin()

combined_songs_df |>
  ggplot(aes(x = song_group, y = energy)) +
  geom_violin()

combined_songs_df |>
  ggplot(aes(x = song_group, y = loudness)) +
  geom_violin()

combined_songs_df |>
  ggplot(aes(x = song_group, y = acousticness)) +
  geom_violin()

combined_songs_df |>
  ggplot(aes(x = song_group, y = key)) +
  geom_violin()

## Now you can clean up trash_songs_df and make plots from it
```



















































